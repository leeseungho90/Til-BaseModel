

entities:
    person:          
        processes:
           
            init_productivity:       
                - dur_rest_ARE: 2*(choi>0)
                - productivity: 0
                # destinie (1991)
                # Roux (jusque 2002)
                - mincer : 7.6 + 0.08 * findet + 0.04 * xpr - 0.0006 * xpr*xpr           
                - productivity: if( sali>0,
                            sali*0.5 - 1820*mincer, 
                            0)
                - productivity: if( sali<=0,
                            normal(loc=avg(productivity, filter=(sali>0)), 
                                    scale=std(productivity, filter=(sali>0))), 
                            productivity)                
                
            #source: vos droits services public.fr         
            chomage:
                ####### duree de versement 
                # on la marque en annee mais le calcul est normalement en mois
                - entree_chom : ISUNEMPLOYED and not lag(ISUNEMPLOYED)
                #TODO: avoir une meilleure fonction que duration pour avoir toutes les 
                #preriode d'emploi, la on a que la derniere, on mettra la periode d'evaluation plus tard
                # - show('nombre d entree au chom', count(entree_chom)) 
                - workstate: if(entree_chom,CADRE,workstate)
                - dur_ver: if(entree_chom, 
                                if(age <50 ,
                                        duration(ISINWORK and not WORK_INDEP),  
                                         duration(ISINWORK and not WORK_INDEP)), 
                                0)
                - dur_ver: dur_ver -1                
                - workstate: if(entree_chom,UNEMPLOYED,workstate)
                # - show('nombre dannees de d act', groupby(ISUNEMPLOYED,dur_ver))                 
                               
                # maximum: c'est bien en vrai c'est 730 jours(=2 ans) + 365 jours(=1 ans)
                # ser supprime quand on aura une bonne fonction duration
                - dur_ver: min(dur_ver , 2 + 1*(age>=50))
                # minimum (ne sert a rien tant qu'on est en annee)
                # c'est en fait un condition d'eligibilite
                #122 jours = 4mois
                - dur_ver: if(dur_ver > 0.25, 
                               dur_ver, 
                               0)
             
                # chomage partiel : 182 jours, pas dans le modele pour l'instant
                # convention chomage du 18 janvier 2006 au 31 mars 2009
                - dur_rest_ARE: if(entree_chom, 
                                    dur_ver,
                                    dur_rest_ARE)
                # avant de baisser la duree par un on regarde des cas de prolongation
                # prolongation
                - prolong: (age>61) and (duration(choi>0)>=1 ) # and d'atres truc
                #TODO: a completer quand on aura la fonction qui va bien (voir google group liam)
                - dur_rest_ARE: if(prolong and (dur_rest_ARE==1), 
                                    2,
                                    dur_rest_ARE)    
                - dur_rest_ARE: if((dur_rest_ARE>0), 
                                    dur_rest_ARE-1,
                                    0)   
                                    
                ####### Montant de l'ARE         
                # TODO: ajoute quotite quand dans le modele
                # TODO: parametres et bonne valeur
                #salaire journalier de reference -> faire tourner avant salaire toujours
                #34308 plafond de securite sociale en 2009
                - SJR: if(entree_chom,  
                            min(4*34308,sali)/365, 
                            0)
                - AJ_ARE: 11.57 + 40.4*SJR/100 
                # maximum et minimum
                - AJ_ARE: min( max( AJ_ARE, 57.4*SJR/100), 75*SJR/100)                     

                # passage au net
                # financement retraite complementaire
                - FRC: 3/100*SJR
                # CSG et CRDS sont calcule dans la legislation openfisca
                # mais ce serait plus simple ici non ?
                # Pour l'instant on oublie meme si c'est mal
                # régime local d'assurance-maladie d'Alsace-Moselle
           
                - choi: if(ISUNEMPLOYED and (dur_rest_ARE>0), 
                             if(entree_chom, AJ_ARE*365, choi), 
                          0)
            
            retraite: 
                # Actualisation du nombre d'enfants par régime
                - new_born: invl_mere.count(agem==0) + invl_pere.count(agem==0) 
                - nb_enf_RG: if(WORK_PRIVE, nb_enf + new_born, nb_enf)
                - nb_enf_RSI: if(WORK_INDEP, nb_enf + new_born, nb_enf)
                - nb_enf_FP: if(WORK_PUBLIC, nb_enf + new_born, nb_enf)
                
                - nb_pac: invl_mere.count(age <= 18) + invl_pere.count(age <= 18)
                
                - date_depart: date_retired(filter = (agem > 12*55)) 
                - to_be_retired: date_depart <= period and date_depart != -1 and not ISRETIRED
                
                - start_retirement: if(to_be_retired, period, start_retirement)
                - workstate: if(to_be_retired, RETIRED, workstate) 
                - new_rsti: pension_func(filter=to_be_retired)
                - revalo: 0
                - rsti: if(to_be_retired, new_rsti, rsti*(1+revalo))
                - test: count(rsti>0)
                                         
            salaire:
                # 1. Fixed-effect Estimation
                # Estimation is done separately on men and women
                # TODO!!!!! Put a structure on the error term
                #- fe_m: exp(  -.5251655 *dip_1 +  .3420241 *dip_2  -.0264539*dip_3 + .3713648*dip_4 + .2547323*dip_5 + .3079436*dip_6 + .5598593*dip_7 + .4370251*dip_8  -.0212385)
                #- fe_f: exp( -.4058653 *dip_1 + .5101655 *dip_2 + .2111971 *dip_3 + .686208*dip_4 +  .7412198*dip_5 + .8517917*dip_6 +  1.022839*dip_7 + 1.116964*dip_8 -.3739756)
                - fe_m: exp(.1252581*findet   -.0022037*findet*findet - 1.863511)
                - fe_f: exp(.2231182*findet - .0038237*findet*findet - 3.084796 )
                - fixed_effect: if(ISEMPLOYED, if(ISMALE, fe_m, fe_f), 0)
                #
                - dw_m: exp( .2613726*age  -.0022704 *age*age   .0114215 *xpr -.0002497 *xpr*xpr  .0242198  *chomage5 -.3655377 *inactif5 .0396221  *invalide5 
                    + 1.222458*(WORK_PRIVATE) + 1.027292*(WORK_INDEP) + 1.835584*(WORK_PUBLIC) + 1.886519)
                - dw_f:  exp(.205171*age -.0015279 *age*age  + .0305335 *xpr  -.0010088 *xpr*xpr  -.1733858 *chomage5 -.5563171 *inactif5  -.163285  *invalide5
                    +  1.087883*(WORK_PRIVATE) +  1.06635*(WORK_INDEP) + 1.929373*(WORK_PUBLIC) + 3.652019)
                - deterministic_wage: if(ISEMPLOYED, if(ISMALE,dw_m,dw_f), 0)
                
                # AR process for the disturbance term
                - disturbance: 
                #Initialisation
                - wage: 0 
                - wage: if(ISEMPLOYED, deterministic_wage + fixed_effect, wage)
                # For the unemployed, their replacement income should be computed separately
        
                # 2. Arellano-Bond estimation
                # The characteristic of Arellano-Bond estimation is to take the lagged variables as an instrument

                #TODO: modéliser la durée de chômage et les autres durées
                #TODO: Il reste à faire l'estimation d'allocation chômage
                
            rev_cap:
                - capital_inc: l_men.wealth*0.1 * (quimen==1)